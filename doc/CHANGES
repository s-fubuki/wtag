# -*- mode: org -*-
#+OPTIONS: H:1
* Sat Sep 27 07:36:36 2025
** mf-lib-wav.el: 2.2
*** fix: `mf-get-chunks'
 192kHz/24bit など巨大なもので終端チェックがうまくいかなかったため
 SIZE nil の場合 point-max でサイズ計算をしてループ終端チェックとする.

** wtag.el: 4.12
*** `wtag-writable-mode' 時の
 'C-c C-d' (ディスクナンバーのセット) と `C-c C-t' (リナンバー・トラック)の調整

**** `wtag-change-disc-number' ('C-c C-d')
 単純置換だった `wtag-not-available-to-number' を
 リージョンを任意のディスク番号にできるように書換えて関数名も変わる.
 Prefix で与えた番号が新たなディスク番号になる. Prefix がない場合は 1 になる.

 Prefix からは整数しか指定できないので
 以下の `wtag-renumber-tracks'(`C-c C-t') 側の分数表記化の機能を調整した.

**** `wtag-renumber-tracks' (`C-c C-t')
 カスタム変数 `wtag-renumber-tracks' で挙動を選べるようにする.

 1. nil    : 元の表記法を引き継ぐ(従来形式)   "Take Over" (default)
 1. expand : 総数を分母にした分数表記にする   "With Total"
 1. normal : トラック(ディスク)番号のみにする "Basic Number Only"

 一時的に(その Emacs セッション)メニュー "Track Number Adjust Option"
 から選ぶこともできるようにした

**** メニューにはついでに "Prefix Sync Option" も追加.
 書き出ししたときのファイル名のリネームに関するカスタム変数
 `wtag-track-prefix-rename' の一時的な設定ができる(変数自体は元からある).
 
 デフォルトは t ("Sync")で「プレフィクスのトラック番号をトラックタグに合わせてリネーム」
 title ("With Body")なら「ファイル名ボディもタイトルタグに変更」.

 この変数には整数(リネーム時のファイル名の長さ)も指定できるが
 それはメニューでは対応していない.
 書き出し時にファイル名に触れたくないときは nil ("Disable") にしておく.

 - change: この変数が non-nil のとき
  ファイル名にトラック番号プレフィクスが無いときは何もしなかったが
  DISK と TRACK のタグを元にして新たにプレフィクスを追加するようにした.

: "foo(1).mp3" -> "01-foo(1).mp3"

* Sat Aug 30 07:49:23 2025
** wtag.el: 4.4
***  change: `wtag': interactive をコードレターに戻す.
 スラッシュ末尾だと default-directory になってしまったのは一時的に不安定だったせいぽい?

*** fix: `wtag-name-push' no prefix で正常動作していなかったのを修正.

*** new: `wtag-not-available-to-number'
 変数 `wtag-not-available-string' であるディスクナンバーすべてを PREFIX の値にする.
 デフォルトは 1.  ライタブルモード C-c C-d にバインド.
 BUG: 単純にマッチ置換しているだけなので
 3行目以降でディスクナンバー以外にも対象文字列があれば置換してしまう.

* Sat Jun 28 07:38:18 2025
** mf-lib-aiff.el: 2.1
** mf-lib-flac.el: 2.1
** mf-lib-mp3.el:  3.1
** mf-lib-mp3v1.el: 2.1
** mf-lib-mp4.el: 3.1
** mf-lib-ogg.el: 2.1
** mf-lib-utility.el: 2.1
** mf-lib-var.el: 2.1
** mf-lib-wav.el: 2.1
** mf-lib-wma.el: 2.1
** mf-tag-write.el: 2.1
** wtag.el: 4.1
** shuffle-all.el: 3.1
 Emacs 30.1 で lexical-binding 指定しないとバイト・コンパイルで警告されるようになったため、
 すべてのファイルを lexical-binding:t で警告が出ないよう調整し、
 メジャーバージョンをひとつ上げました.

 実際にダイナミック・スコープを利用していてレキシカル対応にコードを書き換えたのは
 mf-lib-mp3v1.el, mf-tag-write.el, shuffle-all.el の 3本のみで、
 他のものはループカウント変数名の変更などの調整です.

* Sat May 31 07:37:25 2025
 表立った変更は殆ど無く、主にバグ取りやコードの整理がメインです.

** mf-lib-mp3.el: 2.44
*** fix: `mf-get-mp3-alias'
 引数の tag list がベーシックなプロパティリストでは無い場合
 正常に動作していなかったのを修正.

*** obsolute: function `mf-get-mp3-alias'
 呼び出し元の mf-alias を書換、そちら(`mf-get-alias-table')に同機能を持たせ不要になったので
 オブソルートしたが、呼び元のオブソルート関数 `mf-alias' がまだあるため
 バイトコンパイルエラーになる.
 それを避けるため make-obsolete 行はとりまコメアウト.

*** change: `mf-get-mp3-alias': 戻値の変更
 元タグにソートタグが無いと nil を戻していたのを
 `mf-id33-tag-default-alias' の値を戻すようにする.
 この変数のデフォルトは `mf-id33-tag-musiccenter-alias'.
 つまりデフォルトだと元タグにソートタグが無い場合は
 ソートエイリアスは Music Center2 対応のものが使われる.
 設定できる有効な値は他に `mf-id33-tag-lame-alias' または nil.

** mf-lib-var.el: 1.37
*** chnage: バッファ・ローカル変数を宣言時にバッファ・ローカル変数として定義
*** fix: `mf-indirect-car' 整数に丸めこんで戻す
 ogg で時間表示が壊れていた.

** mf-tag-write.el: 1.92
*** add: `mf-include-file-name' が non-nil ならその値を image tag の :file に使う
*** change: バッファ・ローカル変数のセット位置等の見直し

** wtag.el: 3.47
*** change: `wtag-view-mode-line', `wtag-image-mode-line'
 mode-name 付随情報のジョイントをコロンから SPACE にする.

***  change: `wtag-safe-sort-code' t なら(デフォルト)
 プロセスに渡す前に sjis 化できない文字を SPACE に置換するようにする(カカシ対策).
 今までは sjis 化できない文字が混じっているタグは
 プロセスに渡さず ""(空文字) を戻すようになっていた.
  nil ならこの処理をしない、またコーディングシステムのシンボルなら
 不正文字の基準を sjis に代えそのコーディング・システムにする.

*** add: `wtag-add-sort-tag'
 t なら元になる MP3ファイルにソートタグがあればそのソートタグをつける nil ならつけない.
 これは今までのままで、これに加えて
 force なら元タグにソートタグが無くとも書き込み時にソートタグを追加する.
 default は t (変更なし).
 force のとき選ばれるソート用タグテーブルは
 `mf-lib-mp3.el' で定義されている `mf-id33-tag-default-alias' の値.
 値として `mf-id33-tag-musiccenter-alias' か `mf-id33-tag-lame-alias' が指定でき
 デフォルトは `mf-id33-tag-musiccenter-alias' で Walkman が認識するソート用タグになる.

*** change: `wtag' interative "D" で末尾スラッシュの影響が無いよう変更
 `interative' でのコードレター引数 "D" や `read-directory-name' から
 入力したディレクトリ名の末尾にスラッシュがあると
 戻値が `default-directory'(バッファのカレント・ディレクトリ) になってしまうので(なぜ?)
 スラッシュがあってもなくても入力されたディレクトリが戻るようにする.

* Sat Apr 26 07:48:00 2025
** wtag.el: 3.42
*** fix: `wtag-next-tag', `wtag-previous-tag':
 編集モード時、文字数ゼロになったブロック位置に TAB で移動できなかった悲しい仕様の改善.
 そんなときは UNDO で消した文字列を一時的に復活させて位置を探すなどしていた.
 加えて行き止まりで Ding(Beep) するようにもする.

*** fix: `wtag-add-sort-tags':
 空文字タグでエラーが起こるのを修正. (通常することはない)

*** change: `wtag-artist-name-truncate-mode'
 minor mode として実装していたのを通常のファンクションにする(機能は同じ).
 マイナーモードはデフォルト enable が非推奨で
 カスタマイズで設定してもうまく動かないための変更.
 `wtag-temporary-track-number-mode' は keymap も使い
 デフォルト nil なのでマイナーモードのままにしておく.

* Sat Mar 22 07:52:39 2025
** wtag.el: 3.39
*** change: 長いバッファ名を短縮化 & モードラインの再配置.
 モードライン右端がなるべく見切れないよう長いバッファ名を短縮化.
 カスタム変数 `wtag-buffer-name' が整数ならバッファ名がそれより長いときその長さに切り詰め、
 nil なら切り詰めない. また文字列ならそれをバッファ名にする. デフォルトは 32. 
 これにより右端が以前ほど見切れなくなったため
 左側に独自に設けてあった wtag-mode-line の内容を mode-name 末尾に付けるようにした.
 その中で使う `wtag-mode-name-alias' の ID3 tag 関係も短かくし
 `wtag-image-mode-line' 時もスクエア画像は片辺のみ表示で短縮化.

 バッファ名は基本アルバム名なので、切れた先が知りたいときはアルバム名を見ればよい.

*** new: カスタム変数 `wtag-mode-line-compact'.
 `wtag-view-mode' と `wtag-image-mode' で
 `mode-line-compact' にセットする値を設定するもの. デフォルト `t'.
 モードラインの連続した余白がひとつに詰めらる.

*** change: prefix を付けてタグを書き戻すとき Artwork も強制更新するようにする.
 今まで別のアルバムから曲を追加したとき等に強制フラッシュ(`wtag-flush-tag' prefix 実行)すると
 アルバム名等共通部分のテキスト系タグが強制的に更新されたが、
 アートワークは更新されなかった(アートワークが別の画像に更新されていればされた).
 が、アートワークもアートワークバッファの内容で書き戻されるようになった.

*** fix: `wtag-flush-tag' 強制フラッシュ時 oma file でのコメントタグの条件処理がおかしかった.

*** fix: `wtag-make-artwork-name'
 アートワークバッファから実行すると、
 ひとつ上のディレクトリにファイルを作ってしまっていたバグを修正.

*** new: face `wtag-hl-line'.

** mf-tag-write.el: 1.89
***  変数 `mf-include-file-name' が non-nil なら、その値を Image TAG のファイル名として埋め込む.

** shuffle-all: 2.30
*** new: 演奏経過時間の割合をモードラインにパーセント表示.
 此の上にマウスを置くと再生中のトラックのタイトルがバルーン表示され
 右クリックすると shuffle-all-minor-mode-menu が現れる.

 カスタム変数 `shuffle-progress-interval' で進捗割合の更新間隔秒数を指定(デフォルト 5).
 負荷軽減目的でデフォルトでは同時にモードラインの更新はしないのですぐには反映されないが
 カスタム変数  `shuffle-progress-timer-mode-line-update' が non-nil なら
 モードラインも一緒に更新する.

 カスタム変数 `shuffle-all-minor-mode-lighter-label'
 進捗表示のプレフィクス文字列でデフォルトは "▶".

 カスタム変数 `shuffle-global-mode-string'
 non-nil なら mode-line 右端グローバルエリアに `shuffle-title' を表示する(従来互換).

*** fix: カレントバッファ(wtag-view-mode buffer)にいないと Single play mode が効かないバグを修正.

*** fix: `shuffle-shade' face のエラーが出てしまうのを回避.
*** change: `shuffle-all-minor-mode'
 repeat-mode のメッセをメッセージログにも残さないようにする.

*** change: ソースヘッダ部分の Installation: の説明変更.
 `wtag-view-mode-hook' でセットすると Progress が出ないケースが在るので
 単純に `require' するよう設定例を変更.

* Sat Jan 25 07:49:53 2025
** wtag.el: 3.32
*** new: hl-line-mode に対応.
 face `wtag-hl-line'.
 wtag-view-mode menu に hl-line-mode トグルを追加.

*** change: カスタム変数 `wtag-music-players' :type 平滑リスト化.
 評価結果は同じだが設定が無意味に複雑だったのを改善.

*** new: カスタム変数 `wtag-track-prefix-rename' に title を追加.
 ベース名をトラックタグ文字列にする指定.

*** chnage: `wtag-regular-file-name' 文字の切り詰め関数を
 substring -> truncate-string-to-width に変更.

* Sat Dec 28 08:03:32 2024
** mf-lib-mp3.el: 2.41
*** コメント調整 `mf-mp3-lame-abr'
 ABR 指定値の仕様の制限を忘れてしまうので加筆.

*** fix: `mf-mp3-time-from-buffer' 丸めこみを round から floor に変更
 時間計算の整数への丸めこみを round から floor に変更.
 Windows Explorer と 1秒誤差の出るデータがなくなる.

** wtag.el: 3.30
*** new: wtag-temporary-track-number-mode
 wtag-view-mode 時全トラックに仮想の通しトラック番号を打つモード.
 本当のトラック番号は変更されない.
 同一トラック番号の混在するディレクトリでも
 music play 等が正常に使えるようになる.
 `#' にバインド.
 この状態がアクティブなとき `q' はこのモードから抜ける動作になる.

*** new: カスタム変数 `wtag-track-prefix-rename'
 整数を指定するとファイル名ベース部分をその長さに丸め込み
 シンボル title を指定するとベース部をタイトルタグと同じにする.
 この場合長さの指定などは `wtag-regular-file-name-re' と `wtag-regular-file-name' を見る.
 丸め込みに見た目を揃える truncate-string-to-width を使うので
 マルチバイト文字の場合指定したバイト数になるとは限らない.
 またリネームにエラーハンドラを追加.
 他のハンドラによって殺されてしまい無意味な可能性があるがまだ詳しくは未検証.

*** change: 関数 `wtag-track-prefix-rename'
 ファイル名のプレフィクスに追加されるトラック番号をタッチするとき
 その前に(あるなら)ディスクナンバーもつけるようにする.

*** chnage: `wtag-regular-file-name' 文字の切り詰めを
 substring -> truncate-string-to-width に変更.

*** change: すべての overlay priority の定数を変数化する.

*** fix: `wtag-protect' 少し前の表示形式変更にループの覚書を合わせる.

*** fix: `wtag-jump-list'
 トラックナンバーが(マルチディスク)通し番号だと各ディスク頭で停止しなかった.

*** change: `wtag-next-marked', `wtag-previous-marked'
 最終マッチまで行って戻るとき ding を鳴らす.

*** change: `wtag-works' :trackmax に総トラック数をセット.

*** change: `wtag-view-mode' バインド調整.
 dired に無いので `wtag-mark-toggle-forward' は無くし
 `t' を `wtag-mark-toggle-all' とし
 `M-t' に逃がしてあった `wtag-invisible-toggle' を `T' にする.

* Sat Nov 30 07:51:29 2024
** wtag.el: 3.23
*** wtag-view-mode: マーク関係を dired の操作感や見た目に近づける

| m   | mark               |            |
| u   | unmark             |            |
| U   | unmark all         |            |
| M-{ | previous mark      |            |
| M-} | next mark          |            |
| t   | mark toggle        | T から変更 |
| %m  | mark regexp        |            |
| %t  | mark title regexp  |            |
| %a  | mark artist regexp |            |
| C   | copy               |            |
| d   | delete mark        | D から変更 |
| x   | execute delete     |            |

 `wtag-mark-toggle' を `t' にバインドしたので `wtag-invisible-toggle' は `T' に移動.

*** change: テキストプロパティ位置の変更
 Filename Property を行頭, stat プロパティを行末,
 1行目行頭だった directory property は行末に移動.

*** new: face `wtag-marked' Mark Title 用, `wtag-flagged' Delete Mark Title 用

*** change: 変数 'wtag-name-push' 1-prefix の追加と一部対象の入れ替え
 キルリングにタイトルなどをコピーする機能ですが、
 様式的配置だったのを実用的配置に変更(`C-u w' と `'C-u 0 w' の機能を入れ替え).

| 実行する行 | w          | C-u w                       | C-u 0 w        | C-u 1 w        |
|------------+------------+-----------------------------+----------------+----------------|
| 1行目      | アルバム名 | アルバムアー名 - アルバム名 | アルバムアー名 | ディレクトリ名 |
| 2行目      | 年         | ジャンル                    | コメント       |                |
| 3行目以降  | 曲名       | アー名 - 曲名               | アー名         | ファイル名     |

#+BEGIN_SRC emacs-lisp
wtag-name-push^J
((album (album " - " a-artist) a-artist directory)
(year genre comment)
(title (artist " - " title) artist filename))
#+END_SRC

*** new: `wtag-track-sort-function-select' 読み込みソート秩序を再設定しリロード
 変数をセットしなおして再起動しないといけなかったのをそのままできるようにする.
 暫定的に `M-s s' にバインド.
 `C-c C-s' に充てようとしたが save と誤押ししそうなので避けた.
 ソートするルールはそのリロードのときのみです.
 デフォルトにしたい場合はカスタム変数 `wtag-sort-track' で設定する.

*** fix: `wtag-renumber-tracks(C-c C-t)', `wtag-transpose-lines(C-x <up>/<down>)',`wtag-transpose-lines2(C-x C-t)'
 oma だと動かなくなっていたのを修正.

*** change: `wtag-directory-set' read message を分数表示

*** fix: `wtag-get-mark-titles' マークなしのときソートフラグをセットしていなかった
 マークなしでコピーするとソートタグが再調整されていなかった.

*** fix: `wtag-copy' コピー先のリロードメッセージを抑止
 コピー後にコピー元がリロードされたかのように勘違いしてしまうため.

*** new: `wtag-view-mode' のとき Track Number の help-echo にファイル名(ファイルサイズ)を追加

*** fix: `wtag-view-mode-map' "Quit" のバインドが `wtag-quit' に直し忘れていて
 ウインドウが閇じるだけになっていた.

*** change: 紐づいているアートワークバッファ名を得る方法の変更
 ベース名から生成して探していたが、 バッファ・オブジェクトを保存しておき
 そこから得るようにする.

*** change: `wtag-add-image-suffix' 判別に webp 追加
 webp なのに拡張子が jpg などのときアートワークに設定されてしまうのでその対策.

*** change: `wtag-artwork-write' artwork buffer でも動くようにする

*** fix: アートワークバッファで `wtag-quit (q)' するとインデックスバッファに移動するようにする
 但し何かの拍子でアートワーク・バッファのウィンドウのみになっていたときなどは
 ウィンドウを閇じ別のバッファ(other-buffer)が開く.

** mf-lib-mp3.el: 2.40
*** 時間計算の丸め込みを round から floor に変更
 曲によっては Windows エクスプローラの表示と 1秒の誤差があったが一致するようになった.
 
* Sat Oct 26 07:44:45 2024
** wtag.el : 3.5
*** fix: 存在しないタグを変更するとエラーで止まってしまうのを修正.
 例えば ".oma" にはディスク・ナンバー・タグが無いが、そこをエディットすると
 子プロセスの mf-tag-write でエラーになってしまっていた.
 ".oma" のときはエディット・モードでディスク・ナンバーを修正できないようにして対応.

*** change: `wtag-y-or-n-p' を interative の中で呼ぶようにする.

* Sat Sep  7 07:31:17 2024
** wtag.el : 3.3
*** change: 問い合わせ系変数の名前を変更する仕様変更でメジャーバージョンを 3 にアップする
 問い合わせ系変数の変更や画像キープ設定をしている人は次項を参照してください. 

*** change: 問い合わせ系カスタマイズ変数を `wtag-without-query' に統合
 以下の 4つの変数を廃止して対応関数を `wtag-without-query' にまとめて設定するように変更.
 | 古い変数                               | 対応する関数             |                                                              |
 |----------------------------------------+--------------------------+--------------------------------------------------------------|
 | wtag-load-without-query                | wtag-artwork-load        | アートワークのロード                                         |
 | wtag-artistname-copy-all-without-query | wtag-artistname-copy-all | アルバムアーティスト名を全トラックのアーティスト名にコピー   |
 | wtag-all-title-erase-without-query     | wtag-all-title-erase     | すべてのトラック名を空にする(全タイトルコピペする前等に使う) |
 | wtag-track-number-adjust-without-query | wtag-track-number-adjust | トラック番号を整える                                         |

 例えば wtag-artwork-load と wtag-track-number-adjust を実行時の問い合わせなしにしたい場合

: (setq wtag-without-query '(wtag-artwork-load wtag-track-number-adjust))

すべて問い合わせなしにしたい場合は t でも OK.

: (setq wtag-without-query t)

デフォルトは nil で, すべて問い合わせが入ります.

*** 重要 change: ジャケ変更時元の画像を保存しておく keep 設定の変更
 専用変数 `wtag-artwork-keep' に変更.

: (setq wtag-load-without-query 'keep) ;; <- 廃止された古い設定法
: (setq wtag-artwork-keep t)           ;; <- 新しい設定法

*** fix: `wtag-all-title-erase-without-query' 意味が反転しているのに気づき修正

*** add: `wtag-variable-name-change' 変数変更ワーニング
 起動時に keep 設定の仕様変更を警告します. 不要な場合は以下のようにしてください. 

: (setq wtag-variable-name-change nil)

*** fix: 書き出した後のリロードで画像ロード問い合わせが入ってしまうバグを修正
 ロード問い合わせありにしていると起きていました.

*** change: `wtag-safe-keep-name'整理
 キープ画像ファイル名がかぶらないように番号を振っているが,
 最後のものが番号なしになる仕様だったのを
 一番最初のものが番号なしで順次番号を振りインクリメントされていく
 一般的な仕様になりました.

*** add: `wtag-artwork-write'
 表示されているアートワークを `wtag-artwork-write-file-name' で設定したファイルにセーブ.
 これも先の連番仕様になっています.

*** fix: `wtag-get-mark-titles' 目的プロパティが得られないとき nil を戻す
 nil ではなく nil のリストを戻すバグがあった.

*** change: `wtag-copy' コピー先に dired buffer を追加
 また Directory チョイスは prefix 起動のときのみにする.

*** change: `wtag-regular-table' Music Center2 と同一にする
 MusicCenter2 と japan-util.el だと正規化ルールが多少違っていたことが判明したので.

*** delete: 変数 `wtag-log-save'
`wtag-log-file-name' の設定だけでログセーブする/しないの制御ができるため削除.

*** change: `wtag-make-sort-string-function' -> `wtag-add-sort-tag'
 設定値が関数として使われていなかったので, 相応しい名前の bool 変数に変更.

*** change: `wtag-sort-filter'
 変数 `wtag-kakashi' がセットされていなときは引数をそのまま戻すようにする.

*** 重要 change: `wtag-startup-hook' と `wtag-writable-tag-hook' を廃止
 其々メジャーモード標準の `wtag-view-mode-hook' `wtag-writable-mode-hook' で済むので
 利用していた場合其々書換えてください.

*** fix: `wtag-open-frame'
 メニューから実行すると何故か表示画像が fit されないので強制的に fit するようにする.

*** add: `wtag-view-mode-map' メニューに `wtag-popup-artwark' を追加

*** delete: `wtag-flush-tag-ask'
 ライタブルモード時 `C-c C-c' するときこの関数を経由し
 バッファが read-only なら問い合わせが入るようになっていたが
 現在 `C-x C-q' はキャンセルがバインドされていて
 ライタブルモード時にリードオンリーモードになることは基本的にはないので
 この関数は外し `C-c C-c' はダイレクトに `wtag-flush-tag' を実行するようにする.

*** マニュアル wtag.org を 1 から書き直した

* Sat Jun 15 07:37:06 2024
** wtag.el: 2.27
*** fix: `wtag-invisible-toggle-all' エンバグして動かなくなっていたのを修正.
*** change: マーク face `wtag-mark' を font-lock-constant-face ベースに変更.
 ディスクナンバーと被っていてマークを使うと気になったので Dired のマークに揃える.

* Sat May  4 08:13:17 2024
** mf-tag-write.el: 1.88
*** fix: `mf-tag-merge' TAG の比較関数が間違っていた.
 `:dsc' が在ればそちらで比較する `mf-get-tag-propety' で照合していなかったせいで
 `TXXX' tag の変更があるとその他の `TXXX' tag が捨てられてしまうバグになっていた.
 1.82 でのエンバグ.
 影響があったのは oma とおそらく sort tag の追加された lame mp3 など.

* Sat Apr 27 06:27:50 2024
** mf-lib-mp3.el: 2.39
*** fix: ID3\4 を ID\3 にして書き戻し時の修正
 コーディングを ID3\3 に合わせていなかったため
 日本語タグだと UTF-8 のまま戻されると化けてしまった.

** wtag.el: 2.25
*** fix: ディスクフォールド時もサーチできるようにする.
 忘れていた `isearch-open-invisible' property の追記.

*** new: コマンド `wtag-invisible-toggle-and-next'
 ポイントのディスクが閉じていれば開き、開いていれば閉じて次のディスクにポイントを進める.
 ディスクエリアにいない場合はポイントを 1行進める.
 PREFIX があれば逆方向に向っていく. tab key にバインド.
 `wtag-invisible-toggle' は `t' に変更. 

*** fix: トラックタグが無いとエラーになるのに対処.

*** change: `wtag-music-file-copy'
 指定ディレクトリが無いとき作るかどうか問い合わせるようにする.
 Yes なら(再帰的に) make-directory しそこにコピーする.
 ここで No するとコピーキャンセルされる.
 指定 directory があればこのくだりはなく単にコピーする.

*** change: `wtag-track-number-adjust' 動作整理.
 元々分数表記にするコマンドでリナンバがオプションだったが、
 デフォルトで分数化とリナンバを合わせて行ない
 オプション(プレフィクス)をディスクを跨いだ通し番号でのリナンバにする.
 non prefix 実行でも問い合わせ時 `a' で通し番号打ちになる.
 
* Sat Mar 30 07:57:31 2024
** mf-lib-mp3.el: 2.38
*** fix: 部分読み込みのときの読み直し時の量を増やす
極端に短かい曲のとき `mf-mp3-lame-abr' で読み込み失敗するので
その読み込み分 21バイトを加算.

*** change or add: mpeg version 2 & 2.5 に再び対応
`mf-mp3-mpeg-frame-p' の戻りリストの最後にコンスセル (MPEG-VERSION . LAYER) を追加.
これは擬似タグ " *time" で得られるデータの最後にもつく.
  ->  (TIME BITRATE SAMPLING-RATE STEREO-MODE NIL NIL MPEG-VERSION).
 - lame 等でエンコードされたデータなら BITRATE はリストになり圧縮時の情報等も判る.
 - MPEG-VERSION は先に書いた通りのドットペアのコンスセル.
 - 前に挟まるふたつの NIL は lib-mp4, lib-flac 互換のため.

*** fix: `mf-oma-tags-analyze' SJIS タグへの対応修正
カスタム変数 `mf-mp3-sjis-force' が non-ni なら SJIS で格納された規格違反のタグに対応.
デフォルトは t で SJIS に対応.
この変数に face を指定すると wtag で SJIS のときその face になる.

*** add: ID3 Version2.4 "ID3\4" の簡易的読み込み対応
`ID3\3' として書き戻す機能も用意したが安全のためデフォルトでは利用できない.
これで書き戻すと TAG テーブルは v2.3 `ID3\3' のものを流用し `ID3\3' のヘッダになる.
`ID3\4' で拡張されたタグを操作すると書き戻しで失われる.
これらの副作用を留意した上書き戻す機能を利用する簡単な方法は
init.el 等に以下のように書いておく.

: (add-hook 'mf-func-get-hook #'mf-mp3-id3-24-mode)

*** change: TLEN tag 無き .oma file の時間計算がやや正しくなる
公式が判った訳ではなく力技でデータを取った結果なので心許無いことには変わりは無し.
対応した(つもり)なのは 352 256 132 128 96 64 48 の各ビットレート.

** mf-lib-mp3v1.el: 1.27
*** new: カスタム変数 `mf-mp3-id31-1st'
non-nil なら ID3 v2 があっても ID3 v1 を優先する.

*** fix: ジャンルが番号文字列(数値ではなく)になっていたので、対応名文字列に変換する

*** add: 極たまにしか出番が無く忘れているので冒頭に実装法や発動ルール作用等を書き留める

*** add: SJIS だった場合も考慮

** mf-lib-mp4.el: 2.6
*** fix: スペルミス訂正 `mf-mp4-reload-maegin' -> `mf-mp4-reload-margin'

** mf-lib-var.el: 1.36
*** add: `mf-function-list' 定義がシンボルなら eval する

*** change: `mf-read-size' mp4 50% -> 30% に戻す
wtag 側ローカルで `mf-mp4-reload-maegin' をつけたすようにしたため.

*** fix: `mf-indirect-car' 整数に丸めこんで戻す
ogg で時間表示が壊れていた.

** mf-tag-write.el: 1.87
*** add: new function `mf-tag-read-alias-plist'
`mf-tag-read-alias' と同形式を plist にしたもの.
(alias (tag . data) ...) を繰り返す形式.

*** new: `mf-tag-write' 5つ目の引数にノーエラーフラグを追加
例えば flac にある `DATE' tag は mp3 には無いので
flac から読んだタグリストにそれが含まれていた場合
mp3 の書き出しにそのまま渡すとエラーになるが
このフラグを立てることによりスルーされるので
タグのコピーが以下のようにフィルタ処理なしで直接できる.
:  (mf-tag-write "foo.mp3" (mf-tag-read-alias-alist "bar.flac") nil nil t)

*** change: `mf-func-get' 第2引数の廃止. 同じ値しか呼んでいないので

***  fix: `mf-tag-merge'
タグを削除する場合、最初のものしか削除していなかったが
指定したタグが複数在ってもすべて削除するようにする.
古い iTunes が mp3 のときコメントタグを拡張タグとして利用していて
一つのファイルにコメントタグが複数入っているものがあった.

** wtag.el: 2.11
*** fix: `wtag-exit' ふたつあったウィンドウが何らかの拍子でひとつになってしまっていた場合
終了時にエラーになってしまうのを修正.

*** add: `wtag-copy' prefix で 通常のファイルコピーでコピーをする
コピー先に wtag buffer が存在していてもタグの調整をせずそのままコピーする.
また wtag buffer としてコピーするときは、コピー先の disk 番号に書換えていたが
ひとつのディレクトリに複数のディスクが入っている場合は困るので
disk 番号はコピー対象から外す.

*** change: `wtag-view-mode-map' バインドを `d' -> 'D' に変更
問い合わせが伴い d でも危険性は低いが Copy に合わ大文字にする.

*** change: 変数 `wtag-sort-track' を defcustom 化
合わせて file name でソートする `wtag-sort-file-name' を追加.

*** change: ascii 逆正規化(全角化)を自前関数でやるように変更
`japanese-zenkaku' のテーブルを個人的に書換えていて
MusicCenter の全角化と食い違いがあったため.

*** fix: 外部変数 `mf-mp4-reload-margin' のスペルミス訂正

* Sat Feb 17 10:14:56 2024
** wtag.el: 2.1
*** new: One Directory に多枚組ディスクすべて入れておくような構成に対応
共用していたディスク番号をトラック枚に個別に扱えるようにした.
画面が少し変わったのでメジャーバージョンを 2 とする.

*** chnage: `P' でのトラック指定の変更
ディスク番号とトラック番号をくっつけて指定するように変更されました.
例えば Disc 2 / Track 5 ならば `25P' となります.
そのディレクトリに1枚のディスクしかない場合は、従来と同じでディスク番号は不要です.
操作を統一したい場合は `wtag-play-single-disk' を nil にしてください.

*** fix: oma file の TLEN タグなしのタイムのとき wtag-format でエラーになるエンバグを修正

*** add: face `wtag-disk-number-other' トラック 1 以外のディスク番号フェイス

*** fix: write `wtag-forward-jump-points' (デフォルトバインド `M-{', `M-}')
いつのまにか動いていなかったことに気づきリライト.
アー名や各ディスク頭のトラックにも立ち寄るようにする.

*** new: view `wtag-forward-disk-points', `wtag-backward-disk-points'. (`[', `]')
各ディスクのトラック1に巡回訪問.

*** new: view - 各ディスク番号1番目のトラックの help-echo にそのディスクの総時間を表示

*** new: カスタム変数 `wtag-disk-name'. 上記に関する文字列

*** chnage: `wtag-artwork-buffer-suffix' を "*a", `wtag-index-buffer-suffix' "*i" に短縮

*** new: view - Disc Area Fold 機能(いわゆる折り畳み)
`wtag-invisible-show', `wtag-invisible-hide', `wtag-invisible-toggle'
とこれらの `-all' 版. `s' `h' `tab' `backtab' `S' `H' 等にバインド. See menu.

*** new: Disc fold 用 カスタム変数 `wtag-ellipsis', フェイス `wtag-ellipsis'

*** new: view `wtag-view-mode-line' に help-echo `wtag-music-title'
モードラインのコーデック表示の上にマウスポインタを合わせると
再生中の曲名がバルーン表示される.
同じものが右端の余白にも出るが、見切れることも多いための措置.

*** change: m4a(mp4) 読み込み時に
mf-lib-mp4.el の `mf-mp4-reload-maegin' を wtag 側ローカルで 0.5 にセットし
数十秒など演奏時間が極端に短かい小さな mp4 ファイルでも時間情報取得に失敗しないようにする.

** mf-lib-var: 1.34
*** chnage: `mf-read-size' 調整

* Sat Dec 30 08:21:26 2023
** wtag.el: 1.311
*** カスタム変数 `wtag-regular-file-name'
ジャケ差し換えをして元ジャケをファイルに保存しておくとき、
アルバム名がファイル名になります.
が、長すぎて書き込みに失敗することがあるので、
長さを設定するカスタム変数 `wtag-regular-file-name' を設けました.

デフォルトは `32' で、アルバム名がそれより長い場合 `32' に切り詰めます.
パスと拡張子は長さに含まれません.
またこの変数に文字列をセットしておけばその名前が使われ、
`nil' なら従来同様アルバム名をそのまま使います.

*** wtag-view-mode 時、ジャンルと年にヘルプエコー(バルーン)で
それぞれの名称が出るようにしました.
どちらも入っていないデータのとき、どちらだか判らなくなるため.

* Sat Nov 18 09:34:57 2023
** wtag.el: 1.307
*** autoload に対応
Emacs 29.x.x からファイルのロードが異常に遅くなったので
init.el からできるだけ require を排除し `autoload' でイけるよう調整 (Windows版の問題?)

今まで init.el に (require 'wtag) と書いていた箇所を以下のようにできます

: (autoload 'wtag "wtag" nil t)

*** fix: アートワークなしデータのエディットをキャンセルするとエラーになってしまうのを修正.
*** fix: リロード時カーソルが index buffer に戻らない場合があるバグ修正.
*** ライタブル時の行移動関係
`wtag-transpose-lines' (C-x C-t) を `repeat-mode' に対応させ、
連続実行する場合 2nd ストロークキーのみで
C-x C-t C-t C-t ... などとイケるようにしたんですが
使い勝手がイマイチだったので

`wtag-transpose-lines2' を作って (C-x C-<up>, C-x C-<down>) にバインド.
実行後カーソルが移動した行に留まるので
C-x C-<up> C-<up> C-<up> .... などと連続実行すると
その行(トラック)をどんどん上下に移動させていけます.
トラック番号は自動的に書き換えられます.

カスタム変数 `wtag-transpose-lines-repeat' が non-nil で有効になりますが、
デフォルト t で有効なので切りたい場合この変数に nil をセットしてください.

元々の `wtag-transpose-lines' は Emacs デフォである 'transpose-lines' そのものなので
今のところ C-x C-t に残してあります.

* Sat Oct 21 08:42:19 2023
** mf-lib-mp3.el: 2.26
*** fix: `mf-oma-tag-read' 読み直し時の量を増やす.
    極端に短かい曲のとき `mf-mp3-lame-abr' で読み込み失敗するので
    その読み込み分 21バイトを加算.

*** fix: `mf-oma-tags-analyze'
    Artwork tag の file name がマルチバイトだと
    その前にある mime を誤読して(マルチバイトとして読んでしまっていた)
    うまく load できなかった bug fix.

** mf-tag-write.el:: 1.79
*** new function `mf-tag-read-alias-plist': mf-tag-read-alias と同形式を plist にしたもの.
     (alias (tag . data) ...) を繰り返す.

*** change: `mf-tag-write' 引数名の簡素化.

** wtag.el: 1.301
*** fix: `wtag-kill-process' kill-process -> delete-process.
    1曲再生したあとそのままだと wtag-process がクリアされず
    その状態でタグ書換起動で同関数を実行したとき
    実プロセスがなく kill-process だとエラーを起こしていた.

*** バイトコンパイル警告を黙らせる微調整.

*** add: 変数 `wtag-startup-hook'.

*** fix: ジャケなしデータに対応.

*** add: `wtag-view-mode-map' C-c C-v で `wtag-version'.

*** ジャケ画像を artwork frame にも D&D できるようになった.

*** change: `wtag-quit' window-configuration で戻すようにする.
    wtag-view-mode-map の `q' もこれで終わるようにする.
    エディット在りで終了した場合 再び idx buffer を経由してしまうのを(帰還ルートが変わってしまう)
    どうしても直せなかったことが理由.

*** fix: `wtag-music-play-mouse' アプリによって終了に失敗するバグを修正.

*** fix: `wtag-popup-artwark' を連続実行したとき画面分割され続けてしまう動作の抑止.

*** バッファ・ローカル変数をひとつにまとめ、プロパティリストで管理.

* Sat Sep 23 08:12:46 2023
** mf-tag-write.el: 1.78
*** change: `mf-tag-write' 引数名の簡素化.

** wtag.el: 1.296
*** - add: `wtag-music-play-mouse' マウスで再生に対応.
    `shuffle-all' を入れてあっても動く.
    対応している訳ではなくたまたま衝突しないからで、
    shuffle 側で Play したときもマウスで停止できるが
    シェードが降りたままになる等弊害もある.

* Sat Aug 26 08:19:52 2023
** wtag 1.288
*** fix: `wtag-flush-tag' `oma' では comment tag を付けないようにする.
*** change: `wtag-artist-name-truncate' アルバム・アーティストにも縮小対応.

* Sat Jul 22 08:18:17 2023
** mf-lib-mp3.el: 2.25
*** fix: `mf-oma-tags-analyze'
    Artwork tag の file name がマルチバイトだと
    その前にある mime を誤読して(マルチバイトとして読んでしまっていた)
    うまく load できなかった bug fix.

*** fix: `mf-oma-tag-read' 非インタラクティブ実行だと、
    全読み込み時にビットレートの平均値を出さないバグを修正.

*** chnage: `mf-mp3-lame-abr' LAME Magic を
    変数化(`mf-mp3-lame-magic-re')し "\\`GOGO" も許容するようにする.
    ただ午後のこ〜だが Win10 で動かなかったのでデータを使った検証はしていない.

** wtag.el: 1.287
*** change: `wtag-artist-name-truncate' アルバム・アーティストも縮小表示に対応.

* Sat Jun 17 08:08:24 2023
** mf-lib-mp3.el: 2.22
*** add: LAME ABR のビットレートを得る
    可変ビットレートの場合リストの残り引数に
    エンコード時のいくつかのパラメータが入る.

*** fix: ID32 のコメントタグの終端獲得を直していなかったのを修正.

** mf-lib-var.el: 1.31
*** change: `mf-read-size' mp3 を 10% -> 40%
    LAME のヘッダ域まで読むとなると
    小さな mp3 の場合 10% では足りないようなので 40% にする.

** wtag.el: 1.286
*** add: カスタマイズ変数 `wtag-time-form' の引数を追加
    0 から数えて 3つ目の引数を追加.
    引数が 1なら prefix、 ツールチップ(バルーンヘルプ)もその値になる.
    2つなら 2つ目が prefix とツールチップ兼用になる.
    3つ目があればそれがツールチップ専用になる.
    つまり3つ指定するとすべてを別々の値にすることができる.
 
    デフォルト値は以下の設定になっていて、
    MP3 だとツールチップが常に LAME ABR のビットレート表示になっている.

#+BEGIN_SRC emacs-lisp
  '((mp3 "%2m'%02s\"" "%2m'%02s\"%4bk(%r%v)" "%2m'%02s\"%4ak [%r%v]")
    (mp4 "%2m'%02s\"" "%2m'%02s\"%4bkbps %B/%r%v")
    (*   "%2m'%02s\"" "%2m'%02s\"%4bkbps %B/%r"))
#+END_SRC

*** `%b' ビットレート
    全読み込で平均ビットレート、そうでないとき可変ビットレートなら
    フレーム1 のビットレート(たいていは 128)になる.
    但し LAME ABR ならエンコード時に指定したビットレートになる[fn:: 但し LAME が 255 までしか記録できない仕様なので、指定時の値がそれ以上、例えば 256 でも 320 でも一律に 255 となる].

*** `%a' LAME ABR の値
    常にエンコード指定時の値が得られる.
    但し LAME でないなら フレーム 1の値になる.

*** `%v' VBR なら種別文字列
    LAME Header を見て "abr" などになる.
    詳細は変数 `wtag-time-option-mp3-vbr-method' 参照.

    % 展開の詳細は関数 `wtag-format や `format-seconds' を参照してください.

*** add: `wtag-put-mark-time' マークファイルの積算時間表示
*** change: `wtag-comment-disable-file-regexp' から flac, ogg を外す

* Sat May 27 08:51:35 2023
** mf-lib-* すべて
*** fix: mf-tag-read-(alias|alist) 等からも mf-current-* 系変数を参照できるようにした.

** mf-lib-aiff.el: 1.4
*** chnage: `mf-aiff-tag-read': 戻値の mf-type-dummy を mf-aiff-mode-tag にする.

** mf-lib-flac.el: 1.63
*** change: lib-ogg に合わせ変数 `mf-flac-vendor' を " *vendor" に変更.
*** add: `mf-flac-tag-alias' に comment を追加.

** mf-lib-mp3.el: 2.15
*** CHNAGE: 関数 `mf-mp3-times' 引数変更.
    lib-mp3v1 からも `mf-mp3-times' を使うようにした際、判りにくかったので整理した.
*** fix: `mf-byte-com-33' コメント本体は asxiiZ 化しない.
    `mf-byte-com' を同様に直したとき、こちらを忘れていた.

** mf-lib-mp3v1.el: 1.23
*** add: `dired-id32-to-id31'.
*** change: `mf-id31-tag-read' 時間情報も得る.
*** fix: `id31-get-tags': id31-tbl-ex, id31-tbl 判定位置ミス.
*** fix: `id31-get-tags': magic, zero-byte は除外しリターン値に積まない.
    これにより `mf-tag-write:mf-list-convert' が誤動作してしまうのを回避.
*** chnage: `id31-get-tags': `id31-get-tags-filter' で戻すリストの末尾空白を除去.
*** chnage: `id31-add-genre' バイトコンパイルで警告が出るので位置変更.

** mf-lib-mp4.el: 2.5
*** chnaged: function `mp4-stsz-sample-size'
    `mf-buffer-read-unpack' の仕様変更に合わせ引数 T を M に変更.

** mf-lib-ogg.el: 1.7
*** change: *time に chnael 情報を追加. 他も判れば随時追加予定.

** mf-lib-var.el: 1.28
*** add: 変数 `mf-current-alias', `mf-current-values'.
*** change: `mf-type-dummy' の値を " *ver" -> " *type".
*** add: `mf-buffer-read-unpack' に asciiZ string 読み込み z, Z を追加.

** mf-lib-wav.el: 1.16
*** add: `mf-pack-list' のコーディングシステムを設定する変数 `mf-lst-pack-coding-system'.
    Windows10/11 のワールドワイド言語サポートでユニコードを使用にした場合
    この変数を utf-8 にしないと WMP でのタイトル表示が化ける. デフォは utf-8 今までは sjis.
*** chnage `mf-get-wave-time' 戻値にサンプリングレート, チャンネル数, ビット長 を追加.

** mf-lib-wma.el: 1.7
*** rename `mf-buffer-read-quad-long-word-le' -> `mf-buffer-read-quad-word-le'.

** mf-tag-write.el: 1.77
*** add: `mf-tag-read-plist'  plist でタグ情報を得る Test 的追加関数.
    デフォルトで内部的に扱っているタグ毎の plist ではなく 1file:1plist のシンプルな形式.
*** rename: `set-make-local-variables' ー> `mf-set-make-local-variables'.
*** add: `mf-current-values' mf-current 関数のシンボルリスト.
*** change: `mf-string-equal': `mf-current-case' が定義されているかも試す.
*** fix: `mf-assoc-property': `equal' を `mf-string-equal' にする.
*** fix: `mf-pair-set' data が nil のときそれを正しくセットできていなかったのを修正.
    このバグでタグの削除がうまく動いていなかった.
*** change: 'mf-add-tags を書き直し 'mf-tag-merge とする.

** wtag.el: 1.277
*** change: `wtag-view-mode-line':  mp3, wav の場合 `wtag-mode-string' で
    サフィックスとモードを結合した文字列を表示する.
*** fix: `wtag-directory-set' result の null チェック判断の誤り.
*** chnage: `wtag-beginning-string' コメタグの無い(と思われる)コーデックははじく.
    `wtag-comment-disable-file-regexp' で除外するファイルパターンを指定.
*** add: コメントタグの内容を 2行目3つめの項目に追加("ジャンル/年/コメント" となる).
    但し長いコメントは触りだけ表示し修正はできない.長いかどうかの判別は単純に改行を含むか否か.
    改行が在る場合は改行までを表示し、最後に `wtag-artist-name-ellipsis' を追加する.
*** add: フェイス `wtag-comment'.
*** add: カスタム変数 `wtag-name-push' 2行目 `C-u 0 w' に当たる箇所に comment を追加.
*** chnage: フェイス `wtag-album-artis' を `font-lock-regexp-face' に変更.

** shuffle-all 1.18
   非同梱のテストプログラムです.
   `playall.el' を Sub directory の中も見るようにゼロから書き直し.
   以下に在ります.
   ふたつ目のアドレスにマニュアルを置いてあります.

   : https://gist.github.com/s-fubuki/1de0bb7cddab734631743c15054ccd3b
   : https://gist.github.com/s-fubuki/1de0bb7cddab734631743c15054ccd3b#file-shuffle-all-org

   playall.el に対応するコマンド名が

   : directory-playall  ->  shuffle-all
   : wtag-playall       ->  shuffle-wtag-play

   になっています.
   が、果たしてこの名前でいいのかまだ整理しきれていません.

   重複再生しないよう最初にデータベースを生成する仕様なのですが
   4,000 mp3 files 程度の環境でしか試していないので
   ファイル数が多いと使いものにならないかもしれません.

* Sat Apr 29 09:12:32 2023
** wtag: revision 1.270
*** add:  `wtag-artist-name-truncate-mode' 
    wtag-view-mode 時 アーティスト名を短かく丸めて表示.
    クラシック等で顕著になりますが、
    アー名が長すぎてタイトルが画面から見切れて何だか判らなくなることがあるので、
    そのような状況をなるたけ回避するためのものです.

    デフォルトではイネーブルで `.' でトグルします.
    変数 wtag-artist-name-truncate-mode を nil にしておくことにより
    デフォルト ディゼブルにできます.

    - 通常ソートタグを表示する :help-echo いわゆるバルーンヘルプは丸める前の名前を表示します.
    - overlay で見た目を丸めているだけなので mark-whole-buffer などでコピーすると
    丸められていない元のデータがコピーされます.

**** `wtag-artist-name-truncate-length' で丸める長さ, デフォルトは 24.
**** `wtag-artist-name-ellipsis' に 丸めた文字列の末尾に付く文字列. デフォルトは "...".
     文字列ならそのまま、nil ならなし、 t なら`truncate-string-ellipsis' の値になります.

*** add: 関数 `wtag-writable-tag' のエディットに入る直前に `wtag-writable-tag-hook' を追加.

*** chnage: `w' でタイトル等をヤンクコピーできますが、コードを刷新し設定変数も変更されました.
    `w' でタイトル、 `C-u w' でアー名, `C-u 0 w' でアー名とタイトルがヤンクにプッシュされます.
    アルバムタイトルライン等も同様な動作になります.
    それぞれのアクションに対してプッシュされるパートは変数 `wtag-name-push' で設定されています.
    以前は `wtag-point-file-name-to-kill-buffer-tag' と
    `wtag-point-file-name-to-kill-buffer-list' に分れていたものがひとつになりました.

    `wtag-name-push' は 3要素のリストで、ひとつめがアルバム名行に、ふたつめが年とジャンル行に、
    そしてみっつめが曲目行にそれぞれ対応しています.
    各要素が (`w' `C-u w' `C-u 0 w') の設定に対応していて、タグエイリアスで指定しますが、
    リストになっていると繋げてひとつの文字列にします.
    エイリアスシンボルでなく文字列ならそのまま concat されます.

  : wtag-name-push
  : ((album a-artist (album " - " a-artist)) (year genre) (title artist (artist " - " title)))

*** fix: `wtag-format' trim 非追加を Emacs 29 決め打ちから 29 以上ならとする.

* Sat Apr 15 08:09:27 2023
** mf-lib-mp3.el: 2.11
*** fix: `mf-byte-com' コメント部分を asciiz ではなく通常の ascii にする.

** mf-tag-write.el: 1.74
*** fix: artwork 指定にバイナリオブジェクトを使うと動かないバグの修正を更に修正.

** wtag.el: 1.261
*** fix: `wtag-format' trim 処理非追加を Emacs 29 限定から 29 以上ならとする.

*** fix: `wtag-open-frame': エンバグし新たなフレームが画像バッファにならなかったバグを修正.

*** chnage: 省スペースの為、モードラインから mode-line-position を削除.

* Sat Mar 18 14:16:11 2023
** mf-lib-mp3.el: 2.10
*** fix: コメントタグのデータを asciiZ ではなくする.

** mf-lib-mp3v1.el: 1.20
*** fix: 対応するジャンル番号が存在しないとエラーになるのを修正.

** mf-tag-write.el: 1.73
*** fix: バイナリオブジェクトを直接指定したとき動かなくなっていたバグの修正.
    引数でアートワーク指定するとき、
    ファイル名ではなくバイナリオブジェクトでデータ指定をすると動かなくなっていたのを修正.

*** add: 関数 `mf-tag-read-alias-alist' の追加. 
    mf-tag-read-alias の完全な alist で戻す版.
    mf-tag-read-alias はタグも混ぜて (alias tag . data) で戻すが、これは (alias . data) で戻す.
    加工なしでそのまま入力引数に使えるのでタグのコピーが多少簡易に書ける.

    : ;; "src.mp3" のジャケを "dst.mp3" にセット.
    : (mf-tag-write "dst.mp3" (list (assq 'cover (mf-tag-read-alias-alist "src.mp3"))))

** wtag.el: 1.257
*** fix: 書き出し時に画像が jpg じゃないとエラーで止まってしまうのを修正.

*** chnage: buffer list にアートワークバッファが現れないように変更.
    表示させるには変数 `wtag-artwork-buffer-prefix' を nil にする.

*** change: 変数 `wtag-music-players' のデフォルトプレイヤを mpg123 に変更.

* Sat Jan  7 08:39:11 2023
** mf-lib-mp3v1.el 1.18
*** fix: `mf-list-convert' の必須引数が増えたので合わせる.
*** change: `id31-add-dummy-footer' space で fill ってたのを zero fill にする.
*** fix: `id31-get' 対応するジャンル番号が存在しないとエラーになるのを修正.

** mf-tag-write.el 1.71
*** `mf-list-convert' 周りの整理.

* Sat Dec 31 08:13:00 2022
** mf-tag-write.el 1.68
*** fix: mp3 "ID3\2" の書き出しで PIC tag のフォーマット種が JPG でも  PNG になっていたのを修正
*** `mf-list-convert' 周りのコード整理.

** wtag.el 1.245
*** fix: 元画像を保存する場合 jpg じゃないとエラーで止まってしまうのを修正.
*** add: カスタマイズ変数: `wtag-music-play-next' プレイ実行でポイントを1行進めるか?
*** change: `wtag-music-play' ポイントがとっぱずれにあるときは1曲目に移動する.

** mf-lib-mp3.el 2.8
*** アナライズ、バイナリパッキング周りのコード整理.

** mf-lib-var.el 1.26
*** add: `mf-buffer-read-unpack' に asciiZ string 読み込み z, Z を追加.
*** changed: `mf-buffer-read-functions' t(T)(Triple/Twenty-Four) を m(M)(Middle) に変更.

** mf-lib-mp4.el 2.3
*** chnaged: function `mp4-stsz-sample-size'
    `mf-buffer-read-unpack' の仕様変更に合わせ引数 T を M に変更.

* Wed Dec 14 12:33:35 2022
** wtag.el 1.242
*** change: 時間表示用カスタマイズ変数の整理
    変数 wtag-time-form-balloon や %o(wtag-time-o) を廃止し `wtag-time-form' に統合.
    `wtag-time-form-balloon' でセットしていたバルーン表示は
    prefix 時と同じ `wtag-time-form' の CDR から得るように変更.
    同様に `wtag-time-all-form-balloon' も `wtag-time-all-form' に統合.

    またタイプをつけたリストにするとファイル種別により振り分けできるようになった.
    以下に設定例を列挙します.

- バリエーションなしの一番シンプルな例
: (setq wtag-time-form "%2m'%02s\"%4bkbps %B/%r%v")

: -->  1  3'25" 303kbps 16/44.1/vbr Billie Holiday  I'm A Fool To Want You

- プレフィクス起動時やバルーンを詳しくする(従来の動作とコンパチ)
: (setq wtag-time-form '("%2m'%02s\"" . "%2m'%02s\"%4bkbps %B/%r%v"))

mp3 の場合プレフィクス起動で、すべて読み込んで VBR の計算をするので、
プレフィクス時のみビットレートを表示するこの設定だと表示の整合性がとれます.

:        -->  1  3'25" Billie Holiday  I'm A Fool To Want You
: prefix -->  1  3'25" 303kbps 16/44.1/vbr Billie Holiday  I'm A Fool To Want You

- タイプ別にする例(今回の新たなデフォルト)
以下のような設定だと mp3, mp4(m4a) だけ個別で * がその他になります.
#+BEGIN_SRC emacs-lisp
(setq wtag-time-form '((mp3 "%2m'%02s\"" "%2m'%02s\"%4bkbps (%r%v)")
                       (mp4 "%2m'%02s\"" "%2m'%02s\"%4bkbps %B/%r%v")
                       (*   "%2m'%02s\"" "%2m'%02s\"%4bkbps %B/%r")))
#+END_SRC

**** フォーム中の特殊文字.
     コーデックの種類によって得られない値は「%B は 16, %v は空文字」等の固定値になっています.
     パディング幅指定の数値が指定できます.
#+BEGIN_SRC 
%h  Hour
%m  Minutes
%s  Second
%b  Bit Rate
%B  Bit Size
%c  Channel
%r  Sampling Rate
%t  Codec Type
%v  VBR なら wtag-time-option-mp3-vbr に設定された文字列.
%% そのもの
#+END_SRC

*** change: `wtag-track-number-adjust' 
    PREFIX があれば強制的に現状の並びで新たな番号を振り直す.

*** fix: `wtag-music-play'
    連続実行(実行中の上書き実行)すると `C-c C-c'(`wtag-kill-process')が効かなくなるのを修正.
    但し wmp のみ. Chrome などに渡す場合はうまくいかない.

** mf-lib-mp3.el 2.3
*** change: `mf-mp3-time-from-buffer' 
    可変ビットレートのとき全フレームから計算した値でなくともリストで括るようにする.
    つまりビットレートがリストなら可変ビットレート(Xingテーブル在りデータ)だということ.

*** change: `mf-mp3-time-from-buffer' `mf-oma-time-from-buffer' 戻値の並びの変更.
    lib-flac に合わせ以下の list に変更.

#+BEGIN_EXAMPLE
0: MusicSec
1: BitRate
2: SampleRate
3: Channel
4: Bits/Sample
5: TotalSample (flac のみ)
#+END_EXAMPLE

oma は 2 以降は得られない(取得場所不明)ので無いなど、
コーデックによっては値が無い場合があるがオフセットは統一してある.

また mp3 や iTunes:m4a の VBR のときのビットレートや
oma のとき計算で割り出した時間の場合は値がリストで括られています.
この戻り値フォーマットの変更に伴ないメジャーバージョンを上げました.

** mf-lib-mp4.el 2.2
*** add: 変数 `mp4-vbr'
    t なら stsz(Sample Size Atom) の中のサンプルサイズが 0 なら VBR とする.
    itunes なら iTunes で VBR エンコードしたものなら VBR とする.
    この場合ビットレート値をデータから算出せずエンコード時に指定した値にする.
    nil なら機能しない.
    デフォルトは nil で iTunes でエンコードされたというタグがあっても、ヘッダパラメータからビットレートを計算する.

*** change: *time 戻値の仕様を変更
    なのでメジャー版をひとつ上げる.
1. サンプリングレートやチャンネル数も得る(並びは今回の mp3 の変更項目を参照)
1. iTunes で VBR エンコードされている場合 Bit rate がリストで括られる

*** fix: 上記に伴ない mp4a(AAC) の他 alac にも明示的に対応
    が、表示関係は aac のままになっている(todo).
    alac も QuickTime コンテナに AAC と同じように収まっていてタグの書換ができるが、
    時間情報等が今までちゃんと得られていなかったのを対応.

** mf-lib-var.el 1.24
*** fix & change: `mf-buffer-read-unpack'
    move のバグ修正, 3バイト読み込みの T と、数値でバイト文字列を読み込む拡張.
    結局使っていなくて削除された前身のものとほぼ同じになる.

*** change: 変数 `mf-read-size' mp4 を 50%に変更.

** mf-lib-ogg.el 1.5
*** change: *time に chnael 情報を追加. 他も判れば随時追加予定.
    flac 合わせですが、追加だけで位置の変更はないのでメジャーバージョンはそのままです.

** mf-lib-aiff.el 1.3
*** New: .aif (.aiff) 用読み込み専用ライブラリ.
    利用するには別途 require が必要.
    手元のサンプルだとタグ(ID32)がデータ末尾に付けられていて
    ファイルをほぼ全部読まないと取得できないので,
    サイズ指定引数はダミーで効果なし.

* Sat Nov 19 09:16:17 2022
** wtag.el revision 1.233
*** add: 関数 `wtag-all-title-erase' 全曲タイトルの消去.
    上記コマンドの問い合わせをするかどうかの変数  'wtag-all-title-erase-without-query'.
    スクエアコピー(レクタングルコピー)したものを貼り付けたいときに使いたいので付けました.

*** fix: というか Emacs 29.0.50 で image-mode の挙動が変わったのに合わせ
    アザーフレーム関係で自動フィットしなくなったのを修正.

*** fix: `wtag-reload-buffer' アートワーク窓がダブって開くのを修正.
*** change: `wtag-image-auto-resize': image-mode の `image-auto-resize' が変更されたので合わせる.
*** fix: lib-flac で year タグが表示されていなかったのを修正.

** mf-tag-write.el revision 1.65
*** change: `mf-tag-read-alias' Case Insensitive タイプに ogg を追加.

** mf-lib-var.el revision 1.21
*** add: `mf-write-suffixs' SUFFIXS を書き込み関数のあるものだけにして戻す関数.
*** add: `mf-buffer-read-unpack'.
*** change: 変数 `mf-read-size' の mp4 を 60 -> 20.
*** change: 関数 `mf-read-size' 100% 指定なら計算せず
    実際のファイルサイズをそのまま戻すようにする.

** mf-lib-mp3v1.el revision 1.16
*** change: `mf-id31-add-suffix' 実体ファイルがなければ中身を精査せず
    ファイル名をそのまま戻すようにする.
    よく考えないでやったので、まだ変更の余地在り.

** mf-lib-ogg.el revision 1.4
*** Vorbis: file 用新規ライブラリ. 読み込みのみ対応.
    wtag デフォルトではロードしないので、対応させたい場合は require してください.
    拡張子は .ogg のみ設定してあります.
: (require 'mf-lib-ogg)

** mf-lib-flac.el revision 1.60
*** change: 変数 `mf-flac-vendor' の値を " *vendor" に変更. (lib-ogg に合わせる)
*** change: 変数 `flac-tag-alias' year の値を "DATE" に変更.
    他のコーデックでは日付タグは "year" だが flac では "DATE".
    wtag では year として処理していたため flac のとき年が Not Available(n/a) になっていた.
    なので alias year で引かれると tag "DATE", tag "DATE" で引かれると alias year になるようにし対処.

* Sat Oct 22 08:50:36 2022
** wtag Revision: 1.228
*** fix: 終了時や再読み込み時のウィンドウレイアウトをできるだけ維持
    使っていなかった Copy, Delete 実行後が特に酷かったのでできるだけ対処.

*** change: 書き込み関数が無い場合編集モードにできなくする

*** 重要 change: 書き出し時の prefix の動作の変更
    プレフィクス付で (C-u C-c C-c) 等とフィニッシュすると強制書換になる.
    以前は複数アルバムの混じったディレクトリという特殊な条件下での動作変更だった.
    あまり使用しない上、たまに使いたい場面があっても
    細かい挙動を忘れていて怖くていちいち仕様を確認吟味しないと使えなくて、
    そんな使いにくいものは無いも同然なので判り易い方に譲りました.

*** "29.0.50" Win10月版のバイトコンパイルでのワーニング抑止.

** mf-tag-write.el 1.64
*** change: Write function 未実装だとエラーにする.
    ライブラリに書き込み関数がついていない場合にもセーフティな対応.

** mf-lib-mp4.el(1.12), mf-lib-flac.el(1.57), mf-lib-mp3.el(1.38), mf-lib-var.el(1.16)
*** Emacs "29.0.50" バイトコンパイルのワーニング調整.
    lsh の箇所をすべて ash で書き換え、
    対応コーデックで一通り読み書きチェックはしましたが今後の挙動に注意.

** new: mf-lib-wma(1.5), mf-lib-mp3v1(1.15)
   .wma と mp3 ID1.[01] 用ライブラリ.
   wma は 読み込み専用. 
   mp3v1 は ID1 として読み込み ID2.3 で書き出す. その際 ID tag1 は末尾に残す.
   ぞれぞれ別途ロードが必要 (require 'mf-lib-wma) 等...

* Sat Oct  8 13:59:04 2022
** wtag Revision: 1.219
*** ファイル読み込み時のソートに関する拡張
    基本的にはトラックナバーのタグでソートされるが、
    タグが無い場合はファイル名でソートされます.
    そのときに影響するソートについての拡張です.

**** 読み込み時の基本ソートのオーダー関数(順序を決める比較関数)を、変数 `wtag-sort-track' に設定できるよにする.
**** ファイル名を数値としてソートするオーダー関数 `wtag-sort-track-2' を追加.
     デフォルトでは文字列としてソートされるので "9-file.flac", "10-file.flac" 等と
     トラック数値部分の桁合わせがされていないケースでは "10-file.flac" の方が先になってしまうが
     (setq wtag-sort-track #'wtag-sort-track-2) にすることで回避できる.
     ファイル名自体を変えてもいいんですが.

*** 変数 `wtag-time-form' を拡張
**** ビットレート等を表わす `%b', `%o' 等を追加.
     有効なものは以下.

 | `%h' | 時間.                                                                           |
 | `%m' | 分.                                                                             |
 | `%s' | 秒.                                                                             |
 | `%b' | ビットレート.                                                                   |
 | `%o' | flac なら " 量子化ビット/サンプリング周波数". mp3 且つ 可変ビット長なら " VBR". |

 : (setq wtag-time-form "%2m'%02s\"%4bkbps%o")

 等とすれば時分表示の後にビットレート等が続けて表示される.
 尚、同じディレクトリ内に別形式のものがあることは想定していないので、
 そういう場合は表示桁が揃わず画面が崩れます。

 コンスセルにしてフォーム文字列をふたつ設定すると、後者が prifix 起動時に使われます.
 デフォルトではこの設定を使っています.

**** `%o' 自体の設定
     `%o' 自体の設定も可能で
     mp3 なら可変ビットレートのとき変数 `wtag-time-o-mp3-vbr' の値が使われ、
     flac なら変数 `wtag-time-o-flac-format' が使われ、
     `%B' が量子化ビット数, `%r' が 1/1000 にしたサンプリングレート数になります.

 各デフォルトは

 | wtag-time-o-mp3-vbr     | " VBR".  |
 | wtag-time-o-flac-format | " %B/%r" |

 となっています.
 用途としては小文字にしたい、逆順にしたいなどくらいしょうか.
 
*** fix `wtag-time-foram' -> `wtag-time-form' スペルミス.

*** 変数 `wtag-vbr' が non-nil なら mp3/vbr のとき正しいビットレートを表示.
    変数 `mf-mp3-vbr' をオーバーライドします.
    ファイルをすべて読み込むようになるため起動が遅くなります.
    この変数を設定しないでも prefix 起動することによりそのときだけアクティブにできます.
    また、数値 prefix にすると(C-u 0 等)こちらは無効のまま、
    `wtag-time-form' の CDR 選択のみを有効化することができます.
    起動を遅くせず CBR のビットレート一覧を確認したい等のとき等に利用しています.

** mf-lib-flac Revision: 1.56
*** fix `mf-flac-tag-read' hsize を得る計算ミスの修正.
    このバグによる書き込みへの影響はなし.

** mf-lib-mp3 1.36
*** change 変数 `mf-mp3-vbr' が non-nil なら可変長ビットレートの平均値を得られるようにする. 
    周辺関数を新たに書き直した為、
    mpeg layer によってビットレートなどのテーブルを振り分けする部分は無くなり、 
    mpeg1/layer3 決め打ちになった. が、おそらく問題はないでしょう.

* Sat Aug 20 08:10:55 2022
** wtag 1.207
*** ADD flac, wav で Sampling Rate, Bits長 を表示.
    演奏時間にマウスを置いたときに出るビットレート等のバルーン表示に
    flac, wav のときはサンプリングレートとビット長も表示するようにする.

*** FIX 1行目最後の C-e の挙動の修正
    writable-mode 時 `wtag-end-of-line' アルバム・タイトル行の最後で
    更に押すと止まらず行を飛び越してしまうのを修正.

** lib-flac 1.54
*** ADD 擬似タグ " *time" の拡張
    `*time' tag alias で得られるリストを今までの演奏時間、ビットレートに続けて
    サンプリングレート, チャンネル数, ビット長, トータルサンプル数を追加.

** lib-wav 1.14
*** ADD 擬似タグ " *time" の拡張
    lib-flac に合わせた拡張ですが、こちらには最後のトータルサンプル数は追加されません.

    flac や wav はビットレートよりサンプリングレートやビット数に意味があり、
    知りたいことも多いので今回の変更をしました.

* Sat Aug 13 08:50:56 2022
** wtag 1.202
*** FIX 画像なしデータの再読み込みでエラーを起こしてしまうのを修正
*** FIX mp3 のとき書き込みに失敗するのを修正
    ソートタグを追加しようとして存在しないエイリアスを解決しようとしてエラーを引き起こしていた.
    (Lame対応したときにエンバグ)

*** 廃止 カスタマイズ変数 `wtag-sort-extend'
    ソートタグの追加はソートタグが含まれているか否かで判断するようにしたので不要になった.

*** ライタブルモードにするとき wtag から走らせたプロセスがあれば停止してからモード移行
    問い合わせが入るが、
    カスタマイズ変数 `wtag-process-break' を nil にすると問い合わせしなくなる.

*** 読み込み時にファイルエラーがあればそこで停止する

** mf-lib-mp3 1.30
*** Doc strings の誤字脱字修正. 

* Fri Aug  5 17:33:58 2022
** directory に整理
MSX-DOS から MSX-DOS2 になってディレクトリが掘れるようになったので.
嘘です、ブラウザからアップしていたのをコマンドから更新するようにしたので、です.

** wtag.el 1.197
*** fix: wtag-writable-mode-map RET に存在しないテスト関数が設定されたままだった.
    未定義化.

*** add: wtag-writable-mode-map "M-^" も undefined.

*** change: `wtag-flush-tag-hook' -> `wtag-flush-hook'
    書き出し用フックをタグリスト引数付きにする(アブノーマルフック化).
    名前を短かくして別途作りましたが、元の古い方は廃止予定なので、
    利用していた場合 tag list を引数にして戻す形にして新しい方に移行しておいてください.

*** change: jpg, png 以外だとエラーにする
    jpg, png 以外をセットしようとしても受け付けず反応だったが明示的にエラーにする.

*** add: モードラインに音楽ファイルのタイプを表示
    時間表示箇所にバルーンで出るコーデックも 内部ID からタイプ名に変更.
    この対応は変数 `wtag-mode-name-alias' でカスタマイズできます.

** mf-tag-write 1.62
*** change: jpg, png 以外を受けつけないように戻す
   音楽ファイル側で対応していないため.

* Sat Mar  5 07:34:41 2022
** wtag.el:1.189
*** Emacs 28.91, 29.0.50 で動かくなったのを修正
    file-exists-p が変更されたようで、不正なファイル名だとエラーになってしまうので、
    拡張子によるチェックにして回避.

*** 他のファイル同様リビジョンが大きく変わっている.
    今までの変更過程を RCS file にすべてぶっこんだので.

** mf-tag-write.el:1.60
*** mf-image-type に gif, webp 等も追加(とりあえず使い道はない).
*** 他のファイル同様リビジョンが大きく変わっている.

* Mon Jan 31 14:51:12 2022
** mf-lib-flac:1.52
*** Fix: 時間用のダミータグもヘッダに含めて書き込んでいたのを修正.
    読み込み等でエラーになる場合がありました. 申し訳ありませんでした.

**** バグ版で生成してしまったデータの修復法
     mf-lib-flac.el をこの版に差替えて Emacs を再起動し、
     タグ無指定で mf-tag-write を実行すれば、ゴミを除去してヘッダを再パックします.

     : (mf-tag-write "file.flac")

     Backup を作らず、タイムスタンプを継承する場合

     : (mf-tag-write "file.flac" nil 'no-backup 'stamp-copy)

     ディレクトリごと指定できるコマンド repac-tag もつけておきます.
     指定したディレクトリ内の汚染された flac file だけを書き直しします.
     prefix 起動すると backup を作らず、タイムスタンプを継承します.

 #+BEGIN_SRC emacs-lisp
(require 'mf-tag-write)
(defun repac-tag (dir prefix)
  "DIR 下 の flac が汚染されていればクリーンアップする.
PREFIX 在りだとバックアップなし、タイムスタンプ継承になります."
  (interactive "D: \nP")
  (let ((files (directory-files dir t "\\.flac\\'")))
    (dolist (f files)
      (if (tag-pollution-p f)
          (apply #'mf-tag-write f (and prefix '(nil no-backup stamp-copy)))
        (message "It's Clean: %s" f)))))

(defun tag-pollution-p (flac)
  "flac が汚染タグなら non-nil を戻す."
  (let ((tags (mf-tag-read-alist flac nil t))
        result)
    (dolist (tag tags)
      (if (equal (car tag) mf-time-dummy)
          (setq result (cons tag result))))
    (if (= 2 (length result))
        'pollution)))

(provide 'repac-tag)
 #+END_SRC

*** Add: 変数 `mf-flac-delete-block'
    Music Center 2.5.0 で flac 取り込みをすると APPLICATION ブロックがつくようになったので
    これも削除できるようにしました.
    デリートしたいブロックがある場合、変数 `mf-flac-delete-block' にリストで指定します.

    これに伴ない PADDING 削除指定専用だった変数 `mf-flac-write-safe-pad' は廃止にしたので
    こちらで再設定してください.
    指定できるのは PADDING と APPLICATION で、
    削除したいメタブロックシンボルを指定します(以前の変数とは逆なので注意).

    : (setq mf-flac-delete-block '(PADDING APPLICATION))

*** Change: 変数 `mf-lib-flac-version' について
    Source 管理法を変更したため数値が大きく上がっています.
    あとこのファイルが元々見辛いとは思っていましたが、
    あとから見たとき追加履歴ごとに日付が無いのが致命的に判り難いと今頃気づいたので(遅すぎ)、
    卑近のもので判るものだけざっと追加しておきました.

* wtag 1.19 - Fri Oct 15 15:03:01 2021
** wtag
*** カスタマイズ変数 `wtag-force-load' のデフォルトを nil に変更
    編集モードになっていなくても D&D でジャケット変更できるようにする変数で、
    デフォが 300 だったため最初に 1度だけ編集していいのかの問い合わせが入り、
    これとは別に画像ロード側にも問い合わせがあるので、
    2重に問い合わせが出るようでとまどうので、素の設定のときそうならなくするのと
    安全性向上のための措置. (よく見ると一応メッセージは違う)
    
    関連する変数 `wtag-load-without-query' (デフォルト nil).
    これが t か keep になっていると、画像ロード時の問い合わせが抑止されるため、
    `wtag-force-load' が non-nil で問い合わせが出ても違和感が出ない.

    : ;; 自分的設定
    : (setq wtag-load-without-query 'keep)
    : (setq wtag-force-load 300)

    問い合わせ処理をひとつにまとめようともしたが、
    プログラム側からすると出す箇所が違うのでひとつにはできなかった.
    
*** Fix インデックス・バッファにもサフィクスを追加
    アルバム名をそのままバッファ名にしていたが、
    アルバム・ディレクトリが dired でも開かれていると、
    バッファ名が衝突してしまうため.(何故か開けていて今まで気づかず)

*** イメージ・バッファのモードラインにピクセル・サイズの表示
    本来右側に表示すべきだが、タイトルが長いと見切れて表示されなくなるので、
    タイトルの手前(左側)に表示されます.
    face `wtag-image-size' で色が変更できます.
    : (set-face-attribute `wtag-image-size nil :foreground "green" :weight 'bold)
      
*** ソートタグの中身を対応タグにバルーンする.
    例えば曲名の上にマウスポインタが重なると、
    対応するソートタグがあれば、そこにバルーン表示される.
    ;; Windows 以外だとどうなるのか知らない.

*** ウインドウの開く幅の調整
    インデックス・ウィンドウが曲数に合わせフィットする.
    変数 `wtag-pop-action' を nil にすると以前と同じ等分割になる.
    但しアートワークが上側になるようにしたので、
    位置関係まで同じにするなら以下のようにする.

    : (setq wtag-pop-action '(display-buffer-in-direction (window-height) (direction . above)))

** mf-lib-mp3 時間取得できないと明示的にエラーにする
   計算箇所で意図しないでエラーになりおかしな止まり方をしていた.


* wtag 1.18 - Sat Sep 18 11:12:21 2021
** wtag
*** mf-tag-read: 時間とビットレートの取得
    ダミータグ " *time" に秒数とビットレート(1/1000)をリストで得ます.
    alias シンボルは `*time'.
    通常 2要素のリストですが mp3 は 3要素目にシンボル `vbr' が, oma は `*' が入る事があり、
    それぞれ可変長、誤差在りの場合です.
    m4p は可変長でも何も付きません(現在未調査で未対応のため).

#+BEGIN_SRC emacs-lisp
(assq '*time (mf-tag-read-alias "01-Take It Easy.mp3"))
;; --> (*time " *time" 214 128 vbr)

;; assoc-default (または alist-get) なら CAR にタグ、 CDR にその値が得られる
(alist-get '*time (mf-tag-read-alias "01-Take It Easy.mp3"))
;; --> (" *time" 214 128 vbr)
(mf-sec-to-times 214) ; CADR
;; --> (0 3 34)
#+END_SRC

*** wtag-stat-view:内部のタグ表示.
    曲名の行で `C-c =' するとエイリアスタイプのリストでエコーエリアにすべてのタグが表示されます.
    アートワーク等のバイナリタグは含まれません.

** mf-lib-mp3 lyric 取得時のバグを fix.
   mf-tag-read-alist, mf-tag-read-arias から lyric にアクセスした場合
   正常に動かなかったのを修正.

   lyric から :dsc プロパティを無くし(これをタグと見なし誤動作していた)、
   そこにセットされていたデータを :cdsc プロパティにセットするようにしたので、
   もしこのプロパティを利用している人がいたらそう書換えてください.

** wav ライブラリを追加
  wav 標準の LIST info タグを読み ID3 タグにして書き戻します.
  これらは共存できるのですがどちらを見るかはアプリによって違うので、
  整合性が取れるよう 元の LIST info も ID3 に合わせて書換えされます.
  sjis の LIST が読めずに化けてしまっていた fre:ac でも
  ID3 を参照するようになり正常に表示されます.

  コンテナの配置も変更します.
  WMP で作った wav なのに エクスプローラからはタイトルが見えない等の問題回避をするため、
  コンテナの配置順序を変えます.
  これによりエクスプローラや Grooveミュージックでもタイトルが出るようになります.
  
  mf-tag-write へのライブリの事後追加が正常にできるかのテストを兼ねているので、
  今のところ標準ではインストールされないので、
  必要なら init.el 等で (require 'mf-tag-write) の後に (require 'mf-lib-wav) としてください.

#+BEGIN_SRC emacs-lisp
(require 'mf-lib-wav)
(mf-tag-read-alist "01 乙女 パスタに感動.wav")
;; --> (("TRCK" . "1") ("TCON" . "J-Pop") ("TALB" . "乙女 パスタに感動") ("TIT2" . "乙女 パスタに感動") ("TPE1" . "タンポポ") (" *ver" . "wav") (" *time" 273 1411))
#+END_SRC

** アーカイブの整理
  mf-lib-utility, tiny-ted を外しました.
  サンプルの体で入れていましたが、
  今では関数 mf-tag-read-alias, mf-tag-read-alist 等でタグを抜き出し
  lisp プリミティブな連想リスト関連の関数に渡すだけで平易にタグにアクセスできるので、
  特にサンプルも不要だと思われるのと、
  以前からグシャグシャな utility はサンプルとして如何なものかと思っていたので、
  lib-wav 追加でまたファイルが増えたのを契機に除外しました.

* wtag 1.17 - Sat Aug  8 08:06:36 2020
** wtag:wtag-regular-file-name
   <> 追加と変数化.

* wtag 1.16 - Fri May 29 10:15:49 2020
** Add: トラック・ナンバー・タグを変更するとファイル名もそれに合わせてリネームする.
   変数 `wtag-track-prefix-rename' が non-nil なら
   トラック番号を変更すると書き出すときにファイル名もそれに合わせてリネームする.
   デフォルトは t.

   ファイル名が "01-foo.mp3" のようなとき、タグのトラックを 2 にすると
   "02-foo.mp3" とリネームされる.
   "foo.mp3" のようにファイル名にトラック・プレフィクスがないならリネームはされない.

** Fix: 同じファイルを2度処理しまうことがあった.(mf-tag-write に2度渡してしまう)
   同じ変更を2度行なうので、無駄なだけでデータが壊れる事がなかったので気づかず、
   先のリネームがうまく動かず今頃このバグに気づいた.
   原因は書き出しのときに cursor-intangible-mode を切っておかなかったため.

* mf-lib-utility.el 1.10
** Fix: コマンド `mf-tag-list'
   font-lock で余計なものを捉えないよう正規表現を少し見直す.

** Change: コマンド `dired-rename-file-to-title'
   トラック番号をファイル名プレフィクスにしてリネームするように変更.
   こちらは元のファイル名のプレフィクスにトラック番号がないと付け足してリネームする.


#+date: Fri May  7 10:30:26 2021
* mf-lib-mp3 1.4
** Add: MP3 も現在は Sort 用の TAG が追加されていると知り対応.
   通常の形式("TSOT" の様なタイプ)(MusicCenter2)と
   LAME 独自形式?("TXXX" を使って拡張した "TITLESORT" の様なタイプ) の2形式に対応.
   どちらかのタイプが使われていれば、そのタイプを使ったファイルとして処理します.

* wtag 1.15
** Fix: 変数 `wtag-kakashi' を nil にしても機能が切れずエラーになっていた(気がする)のを修正.
** Add: 連続して wtag-next-line 等のポイントの行移動をしたとき、
   最初 のポイントを勝手にマークするようにした. 
