# -*- mode: org -*-
#+date: Fri Nov 26 17:10:54 2021
#+author: fubuki
* wtag 1.20
** wtag
*** Change: kakasi の挙動調整 for Windows
    MS版カカシがかなり昔にメンテ停止していて SJIS にしか対応していない為の措置。
    変数 `system-type' が windows-nt(または ms-dos)の場合、
    エラー回避するため sjis に無い文字を含むタグは kakasi.exe に渡さないようにする(無変換のまま戻る).

*** fix: タイトルタグが無いときファイル名がタイトルになる
    これがいつのまにか死んでいたので修正.

*** Add: function `wtag-track-number-adjust'. variable `wtag-track-number-adjust-without-query'. 
    すべてのトラックバンバーを分数番号("トラック/トラック数")化する.
    ライタブルモードの C-c C-t にバインド.

** mf-lib-mp3
   (wtag から呼ばれて)ソートタグが追加されたとき、alias が解決できなかったのを修正.
   `mf-id33-tag-default-add-alias' にセットされた alias が追加されるようにした.
   デフォルトではこの変数が `mf-id33-tag-musiccenter-alias' で MusicCenter タイプになる.
   `mf-id33-tag-lame-alias' にしておくことによって LAME type にできる.

* wtag 1.19
** wtag
*** カスタマイズ変数 `wtag-force-load' のデフォルトを nil に変更
    編集モードになっていなくても D&D でジャケット変更できるようにする変数で、
    デフォが 300 だったため最初に 1度だけ編集していいのかの問い合わせが入り、
    これとは別に画像ロード側にも問い合わせがあるので、
    2重に問い合わせが出るようでとまどうので、素の設定のときそうならなくするのと
    安全性向上のための措置. (よく見ると一応メッセージは違う)
    
    関連する変数 `wtag-load-without-query' (デフォルト nil).
    これが t か keep になっていると、画像ロード時の問い合わせが抑止されるため、
    `wtag-force-load' が non-nil で問い合わせが出ても違和感が出ない.

    : ;; 自分的設定
    : (setq wtag-load-without-query 'keep)
    : (setq wtag-force-load 300)

    問い合わせ処理をひとつにまとめようともしたが、
    プログラム側からすると出す箇所が違うのでひとつにはできなかった.
    
*** Fix インデックス・バッファにもサフィクスを追加
    アルバム名をそのままバッファ名にしていたが、
    アルバム・ディレクトリが dired でも開かれていると、
    バッファ名が衝突してしまうため.(何故か開けていて今まで気づかず)

*** イメージ・バッファのモードラインにピクセル・サイズの表示
    本来右側に表示すべきだが、タイトルが長いと見切れて表示されなくなるので、
    タイトルの手前(左側)に表示されます.
    face `wtag-image-size' で色が変更できます.
    : (set-face-attribute `wtag-image-size nil :foreground "green" :weight 'bold)
      
*** ソートタグの中身を対応タグにバルーンする.
    例えば曲名の上にマウスポインタが重なると、
    対応するソートタグがあれば、そこにバルーン表示される.
    ;; Windows 以外だとどうなるのか知らない.

*** ウインドウの開く幅の調整
    インデックス・ウィンドウが曲数に合わせフィットする.
    変数 `wtag-pop-action' を nil にすると以前と同じ等分割になる.
    但しアートワークが上側になるようにしたので、
    位置関係まで同じにするなら以下のようにする.

    : (setq wtag-pop-action '(display-buffer-in-direction (window-height) (direction . above)))

** mf-lib-mp3 時間取得できないと明示的にエラーにする
   計算箇所で意図しないでエラーになりおかしな止まり方をしていた.


* wtag 1.18
** wtag
*** mf-tag-read: 時間とビットレートの取得
    ダミータグ " *time" に秒数とビットレート(1/1000)をリストで得ます.
    alias シンボルは `*time'.
    通常 2要素のリストですが mp3 は 3要素目にシンボル `vbr' が, oma は `*' が入る事があり、
    それぞれ可変長、誤差在りの場合です.
    m4p は可変長でも何も付きません(現在未調査で未対応のため).

#+BEGIN_SRC emacs-lisp
(assq '*time (mf-tag-read-alias "01-Take It Easy.mp3"))
;; --> (*time " *time" 214 128 vbr)

;; assoc-default (または alist-get) なら CAR にタグ、 CDR にその値が得られる
(alist-get '*time (mf-tag-read-alias "01-Take It Easy.mp3"))
;; --> (" *time" 214 128 vbr)
(mf-sec-to-times 214) ; CADR
;; --> (0 3 34)
#+END_SRC

*** wtag-stat-view:内部のタグ表示.
    曲名の行で `C-c =' するとエイリアスタイプのリストでエコーエリアにすべてのタグが表示されます.
    アートワーク等のバイナリタグは含まれません.

** mf-lib-mp3 lyric 取得時のバグを fix.
   mf-tag-read-alist, mf-tag-read-arias から lyric にアクセスした場合
   正常に動かなかったのを修正.

   lyric から :dsc プロパティを無くし(これをタグと見なし誤動作していた)、
   そこにセットされていたデータを :cdsc プロパティにセットするようにしたので、
   もしこのプロパティを利用している人がいたらそう書換えてください.

** wav ライブラリを追加
  wav 標準の LIST info タグを読み ID3 タグにして書き戻します.
  これらは共存できるのですがどちらを見るかはアプリによって違うので、
  整合性が取れるよう 元の LIST info も ID3 に合わせて書換えされます.
  sjis の LIST が読めずに化けてしまっていた fre:ac でも
  ID3 を参照するようになり正常に表示されます.

  コンテナの配置も変更します.
  WMP で作った wav なのに エクスプローラからはタイトルが見えない等の問題回避をするため、
  コンテナの配置順序を変えます.
  これによりエクスプローラや Grooveミュージックでもタイトルが出るようになります.
  
  mf-tag-write へのライブリの事後追加が正常にできるかのテストを兼ねているので、
  今のところ標準ではインストールされないので、
  必要なら init.el 等で (require 'mf-tag-write) の後に (require 'mf-lib-wav) としてください.

#+BEGIN_SRC emacs-lisp
(require 'mf-lib-wav)
(mf-tag-read-alist "01 乙女 パスタに感動.wav")
;; --> (("TRCK" . "1") ("TCON" . "J-Pop") ("TALB" . "乙女 パスタに感動") ("TIT2" . "乙女 パスタに感動") ("TPE1" . "タンポポ") (" *ver" . "wav") (" *time" 273 1411))
#+END_SRC

** アーカイブの整理
  mf-lib-utility, tiny-ted を外しました.
  サンプルの体で入れていましたが、
  今では関数 mf-tag-read-alias, mf-tag-read-alist 等でタグを抜き出し
  lisp プリミティブな連想リスト関連の関数に渡すだけで平易にタグにアクセスできるので、
  特にサンプルも不要だと思われるのと、
  以前からグシャグシャな utility はサンプルとして如何なものかと思っていたので、
  lib-wav 追加でまたファイルが増えたのを契機に除外しました.

* wtag 1.17
** wtag:wtag-regular-file-name
   <> 追加と変数化.

* wtag 1.16
** Add: トラック・ナンバー・タグを変更するとファイル名もそれに合わせてリネームする.
   変数 `wtag-track-prefix-rename' が non-nil なら
   トラック番号を変更すると書き出すときにファイル名もそれに合わせてリネームする.
   デフォルトは t.

   ファイル名が "01-foo.mp3" のようなとき、タグのトラックを 2 にすると
   "02-foo.mp3" とリネームされる.
   "foo.mp3" のようにファイル名にトラック・プレフィクスがないならリネームはされない.

** Fix: 同じファイルを2度処理しまうことがあった.(mf-tag-write に2度渡してしまう)
   同じ変更を2度行なうので、無駄なだけでデータが壊れる事がなかったので気づかず、
   先のリネームがうまく動かず今頃このバグに気づいた.
   原因は書き出しのときに cursor-intangible-mode を切っておかなかったため.

* mf-lib-utility.el 1.10
** Fix: コマンド `mf-tag-list'
   font-lock で余計なものを捉えないよう正規表現を少し見直す.

** Change: コマンド `dired-rename-file-to-title'
   トラック番号をファイル名プレフィクスにしてリネームするように変更.
   こちらは元のファイル名のプレフィクスにトラック番号がないと付け足してリネームする.


#+date: Fri May  7 10:30:26 2021
* mf-lib-mp3 1.4
** Add: MP3 も現在は Sort 用の TAG が追加されていると知り対応.
   通常の形式("TSOT" の様なタイプ)(MusicCenter2)と
   LAME 独自形式?("TXXX" を使って拡張した "TITLESORT" の様なタイプ) の2形式に対応.
   どちらかのタイプが使われていれば、そのタイプを使ったファイルとして処理します.

* wtag 1.15
** Fix: 変数 `wtag-kakashi' を nil にしても機能が切れずエラーになっていた(気がする)のを修正.
** Add: 連続して wtag-next-line 等のポイントの行移動をしたとき、
   最初 のポイントを勝手にマークするようにした. 
