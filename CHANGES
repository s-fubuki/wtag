# -*- mode: org; coding: utf-8-unix -*-
#+date: Wed Sep 30 08:52:58 2020
* rev1.9
** wtag 1.9
*** keep でジャケなしデータにジャケを追加したときエラーになるのを fix
    keep 設定されているとき keep するデータがなくても保護ルーチンを実行してしまいエラーになっていたのを修正.
*** 編集モード時のプロテクト箇所の見た目を修正
    Emacs 27.1 で行末までの未入力部分の表示が変更されたので、 
    26.3 実行時と同じにするため `wtag-protect-face' に新アトリビュート :extend を追加.
*** 編集モード時 曲名もスペースでパディングしてみる
    アー名同様末尾のブランクは書き戻すとき切り捨てられます.
*** fix: `image-auto-resize' が 27.1 前夜版では存在せずエラーになっていた
    27.1 image-mode の追加変数だったので参照時にあるかどうかをチェック.
*** keep file を番号バックアップし上書きロストを防止.
*** `wtag-force-load' が NON-NIL だと wtag-view-mode のとき画像を D&D すると
    そのまま wtag-writable-mode になる. query だと問い合わせが入る. (多分 Windows のみ).
*** 別フレームで開いたアートワークバッファに D&D するとキョドるのを暫定修正
    上の件で今頃これに気づき暫定対処.

** taged
*** fix: `image-auto-resize' が 27.1 前夜には存在せずエラーになっていた
    27.1 image-mode の追加変数だったので参照時にあるかどうかをチェック.

** mf-lib-utility
*** fix: `image-auto-resize' が 27.1 前夜には存在せずエラーになっていた
    27.1 image-mode の追加変数だったので参照時にあるかどうかをチェック.

* rev1.8
** wtag 1.8 [主に wtag-view-mode での拡張]

*** Emacs 27.1 の image-mode で画像がフィット表示されるようになったのをコントロール
 変数 `wtag-image-auto-resize' を nil にしておけば fit されない.
 デフォルトでは `image-mode' の変数 `image-auto-resize' の値を引きぐので通常 fit される.
 ひとつ前の版で適当に対処していたものを 27.1 が正式公開されたのできちんと修正した形.

 バッファに表示中キーボードからフィット/オリジナルスケールをトグルできます.
 `wtag-view-mode' なら `f' または `C-c C-f' で wtag-writable-mode `C-c C-f'.

 この機能は taged にもつけました.(変数 は `taged-image-auto-resize' キーは `C-c C-f')

*** `w' でポイント行のタイトルをキルリングにスタック.
 プレフィクスを付けたときの動作をシンプル化してアーティスト名だけがコピーされるよう変更.

*** 変更前のジャケをファイルに保護.
 変数 `wtag-load-without-query' が keep なら、
 画像差替で問い合わせが入らないことに加え、 差替前のジャケ画像をファイルに保存する.

 曲ファイルと同じディレクトリに「アルバムタイトル.拡張子」で保存される.
 保存されるのは表示されていたもののみで全トラック分ではない.
 対応しているのは jpeg と png のみ.

*** 前置き引数で再生するトラックを直指定できるようになった.
 数値を入力後 `P' を押すとそのトラックを  `wtag-music-player' で再生する.
 return(Enter)不要の less または `view-mode' の行ジャンプのような操作性です.

 今のところトラック番号ではなく行位置で動かしているので、
 アルバムのトラック番号が連続していない場合必ずしも指定したトラックが再生されません.
 どうするかは思案中.

*** menu のおおまかな調整.
 暫定的に書いて余裕ができればやろうと思っておざなっていました.

** taged
*** 変更したアートワークが正常にセーブされないことがあったのを修正
 mf-tag-write 側の引数解析ルーチンのバグが原因でそちらを修正.
 これでファイルを壊してしまった人がいたら申し訳ありませんでした.
 誤って cover tag を lyric tag としてセーブするバグだったので、
 以下のように壊れたデータから lyric tag を取り除けばファイルは正常化します.

 : (mf-tag-write "file.m4a" '((lyric)) "out.m4a")

 cover tag data を mf-tag-write の引数に Object として 渡すのは taged だけなので、
 file で渡す wtag では mf-tag-write のこの不具合の影響はありません.

*** Emacs 27.1 だとカバーアートが正常に表示されない.
 読み込みバッファを明示的にユニバイト化して対処.

*** Emacs 27.1 image-mode の fit 抑止 と表示トグル 
 変数は `taged-image-auto-resize' で、初期値は `image-auto-resize' の値を引き継ぐ.
 フィットと原寸を表示トグルするキーは `C-c C-f'.

*** `taged-popup-artwork' アートワークウィンドウの再表示.
 wtag のものと同様 kill-buffer されていると使えない. `C-c C-a'.

** mf-tag-write
*** jpeg の判断ミスを修正. (taged のジャケ差替に影響があった)
 引数からカバー・タグに直接バイナリ・オブジェクトを指定したときの判定ルーチンのバグを修正.

*** 対象ファイルに未定義なタグ文字列を指定してもエラーにならなかったのを修正.
 エラーにならないどころか存在しないタグがそのまま追加されてしまっていた.
 当時は敢てそうしたのか覚えていないが、
 指定ミスしたまま見過ごしてしまう弊害の方の方が大きいので通らないよう修正.
